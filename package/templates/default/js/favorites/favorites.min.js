var icms=icms||{};
icms.favorites=function(b){this.options={urls:{favorites:"/favorites",autocomplete:"/favorites/autocomplete"},selectors:{comma:".fav_comma",tag:".fav_tag",edit_tag:".fav_edit_tags",paginator:".favorite_info_pagination",form:{tag_form:"#fav_tag_form",tag_input:".tags_string",close:".fav_close"},widget:{widget:".favorite_widget",count:".fav_count"}},data:{action:"action",favid:"fav-id",controller:"target-controller",subject:"target-subject",id:"target-id",url:"url",page:"page"}};this.setOptions=function(a){b.extend(!0,
this.options,a)};this.onDocumentReady=function(){var a=b(this.options.selectors.form.tag_form);a.length&&(icms.favorites.tagsFormAutocomplete(a),icms.favorites.tagsFormSubmit(a),b(a).on("click",this.options.selectors.form.close,function(){icms.favorites.closeTagsForm(a)}))};this.getTagsBar=function(a,c){if(0!==b(a).parent(".tags_bar").length)return b(a).parent(".tags_bar");if(!c)return!1;var d="."+c+"_item";0==b(d).length&&(d="."+c+"_list_item");return b(a).closest(d).children(".tags_bar")};this.toggleFavorite=
function(a){$link=b(a);var c=this;if($link.hasClass("disabled"))return!1;var d=$link.parent(this.options.selectors.widget.widget);a=d.data(this.options.data.controller);var e=d.data(this.options.data.subject),g=d.data(this.options.data.id),l=b(this.options.selectors.widget.count,d),h=isNaN(parseInt(l.text()))?0:parseInt(l.text()),f=icms.favorites.getTagsBar(d,e),m=f?f.html():"",k=$link.data(this.options.data.action);if("delete"===k)var n=$link.data(this.options.data.favid);$link.addClass("disabled");
b.post(this.options.urls.favorites+"/"+k,{tc:a,ts:e,ti:g,fav_id:n},function(a){if(null==a||"undefined"==typeof a||a.error)return b.jGrowl(a.message,{theme:"error"}),$link.removeClass("disabled"),!1;b.jGrowl(a.message,{theme:"info"});$link.toggleClass("fav_add").toggleClass("fav_delete").data(c.options.data.action,"add"===k?"delete":"add").attr("title",a.link_title);"add"===k?h++:h--;l.text(0<h?h:"");"add"===k&&($link.data(c.options.data.favid,a.fav_id),e&&0==b(c.options.selectors.edit_tag,f).length&&
(f.html(b.trim(f.html())),f.append('<a href="javascript:void(0);" class="fav_edit_tags" onclick="return icms.favorites.showTagsForm(this, \''+e+"', "+g+');">'+c.options.lang.edit_tags+"</a>")));"delete"===k&&e&&(b(c.options.selectors.edit_tag,f).remove(),b(c.options.selectors.comma,f).remove(),b(c.options.selectors.tag,f).remove(),b(c.options.selectors.form.tag_form).hide());icms.events.run("icms_favorites_toggle",{widget:d,action:k,tags:m});$link.removeClass("disabled")},"json");return!1};this.showTagsForm=
function(a,c,d){icms.favorites.closeTagsForm();var e=b(this.options.selectors.form.tag_form);b('input[name="ts"]',e).val(c);b('input[name="ti"]',e).val(d);a=icms.favorites.getTagsBar(a,c);var g=[];b(this.options.selectors.comma,a).hide();b(this.options.selectors.edit_tag,a).hide(30);b(this.options.selectors.tag,a).each(function(){g.push(b(this).text());b(this).hide(30)});e.insertAfter(a).show(50).find('input[name="tags_string"]').val(g.join(", ")).focus();return!1};this.tagsFormSubmit=function(a){"undefined"===
typeof a&&(a=b(this.options.selectors.form.tag_form));var c=this;a.submit(function(d){d=b(this).serializeArray();var e="/"+b(this).attr("action");b.post(e,d,function(d){if(null==d||"undefined"==typeof d||d.error)return b.jGrowl(d.message,{theme:"error"}),!1;var e=icms.favorites.getTagsBar(a,b('input[name="ts"]',a).val());b(c.options.selectors.comma,e).remove();b(c.options.selectors.tag,e).remove();b(c.options.selectors.edit_tag,e).before(d.html).show();a.hide()},"json");return!1})};this.tagsFormAutocomplete=
function(a){"undefined"===typeof a&&(a=b(this.options.selectors.form.tag_form));b(this.options.selectors.form.tag_input,a).devbridgeAutocomplete({serviceUrl:this.options.urls.autocomplete,minChars:2,delimiter:/(,|;)\s*/,maxHeight:400,deferRequestBy:300,params:{type:"tags"},onSelect:function(a){b(this).val(function(a,b){return b+", "}).focus()}})};this.closeTagsForm=function(a){"undefined"===typeof a&&(a=b(this.options.selectors.form.tag_form));if(!a.is(":visible"))return!1;var c=icms.favorites.getTagsBar(a,
b('input[name="ts"]',a).val());b(this.options.selectors.tag,c).show();b(this.options.selectors.comma,c).show();b(this.options.selectors.edit_tag,c).show();a.hide();return!1};this.showUsersInfo=function(a){$link=b(a);a=$link.parent(this.options.selectors.widget.widget);icms.modal.openAjax($link.data(this.options.data.url),{tc:a.data(this.options.data.controller),ts:a.data(this.options.data.subject),ti:a.data(this.options.data.id),total:$link.text()})};this.bindUsersInfoPages=function(){var a=this,
c=b(this.options.selectors.paginator),d=c.data(this.options.data.controller),e=c.data(this.options.data.subject),g=c.data(this.options.data.id),l=c.data(this.options.data.url);b("a",c).click(function(){var h=b(this),f=h.data(a.options.data.page),m=b("#favorite_info_window:visible .favorite_info_list");b("a",c).removeClass("active");h.addClass("active");m.addClass("loading-panel");b.post(l,{tc:d,ts:e,ti:g,page:f,is_list_only:!0},function(a){m.html(a).removeClass("loading-panel")},"html");return!1})};
return this}.call(icms.favorites||{},jQuery);