var icms=icms||{};
icms.favtags=function(b){this.options={selectors:{tag:".fav_tag",edit_tag:".fav_edit_tags",form:{tag_form:"#fav_tag_form",tag_input:".tags_string"},widget:{input:"#tags_suggest",clear:"#suggest_clear",top_tags:"#top-tags",all_tags:"#all-tags"}}};this.setOptions=function(a){b.extend(!0,this.options,a)};this.onDocumentReady=function(){icms.events.on("icms_favorites_toggle",function(a){icms.favtags.toggleFavLink(a.action,a.tags)});icms.favtags.tagsWidgetSearch();var a=b(this.options.selectors.form.tag_form);a.length&&
a.submit(function(b){icms.favtags.tagsFormSubmit(a)})};this.toggleFavLink=function(a,e){var d=[];b(e).not(this.options.selectors.edit_tag).filter("a").each(function(a){d.push(b(this).text())});icms.favtags.tagsWidgetUpdate(d,a);var c=b("#user_profile_tabs .active .counter"),f=+c.text();c.text("add"===a?f+1:f-1)};this.tagsFormSubmit=function(a){function e(a,b){var d=[],c;a.every(function(a,f,e){c=!0;b.every(function(b,d,m){return a==b?c=!1:!0});c&&d.push(a);return!0});return d}var d=a.closest(".content_list_item").find(".tags_bar").html(),
c=[];b(d).filter(this.options.selectors.tag).each(function(a){c.push(b(this).text())});d=b(this.options.selectors.form.tag_input,a).val().split(",").filter(function(a,d,c){return b.trim(a)}).map(function(a,d,c){return b.trim(a)});a=e(d,c);d=e(c,d);0!=a.length&&icms.favtags.tagsWidgetUpdate(a,"add");0!=d.length&&icms.favtags.tagsWidgetUpdate(d,"delete")};this.tagsWidgetUpdate=function(a,e){if(0==a.length)return!1;var d=this,c=b(this.options.selectors.widget.clear);c.is(":visible")&&c.click();var c=
b(this.options.selectors.widget.top_tags),f="";b("li",c).each(function(){var c=b(this),h=b(".name",c).text(),g=+b(".count",c).text(),l=!0;a.every(function(a){return a==h?(l="add"===e?++g:--g,!1):!0});l&&(f+='<li><a href="'+d.options.url+encodeURIComponent(h)+'"><span class="count">'+g+'</span><span class="name">'+h+"</span></a></li>")});c.html(f);this.options.tags.every(function(b){a.every(function(c,d){return b.name==c?("add"==e?++b.count:--b.count,a.splice(d,1),!1):!0});return!0});a.length&&a.every(function(a){d.options.tags.push({name:a,
ename:encodeURIComponent(a),count:1});return!0})};this.tagsWidgetSearch=function(){var a=this,e=b(this.options.selectors.widget.input),d=b(this.options.selectors.widget.clear),c=b(this.options.selectors.widget.all_tags),f=b(this.options.selectors.widget.top_tags);e.keyup(function(b){27===b.keyCode&&e.val("");13===b.keyCode&&(document.location.href=a.options.url+encodeURIComponent(e.val()));b=e.val();if(""===b)d.click();else{d.show();f.hide();c.html("");var h="";for(k in a.options.tags){var g=a.options.tags[k];
g.name.indexOf(b)+1&&0<g.count&&(h+="<li><a "+(g.current?'class="current"':"")+' href="'+a.options.url+g.ename+'"><span class="count">'+g.count+'</span><span class="name">'+g.name+"</span></a></li>")}c.append(h).show()}});d.click(function(){e.val("");d.hide();f.show();c.hide().html("")})};return this}.call(icms.favtags||{},jQuery);